!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).gotch=e()}(this,(function(){"use strict";function t(e){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(e)}function e(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function n(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function o(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function r(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);e&&(o=o.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,o)}return n}function i(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?r(Object(n),!0).forEach((function(e){o(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function s(t){return function(t){if(Array.isArray(t))return a(t)}(t)||function(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)}(t)||function(t,e){if(!t)return;if("string"==typeof t)return a(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);"Object"===n&&t.constructor&&(n=t.constructor.name);if("Map"===n||"Set"===n)return Array.from(n);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return a(t,e)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function a(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,o=new Array(e);n<e;n++)o[n]=t[n];return o}return new(function(){function o(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};e(this,o),this.xhrTagMap={},this.config=i({},t),this.initConfig=i({},t),this.restoreConfig()}var r,a,u;return r=o,(a=[{key:"create",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return new o(t)}},{key:"withBaseURL",value:function(t){return this.config.baseURL=t,this}},{key:"withRequestType",value:function(t){return this.config.requestType=t,this}},{key:"withResponseType",value:function(t){return this.config.responseType=t,this}},{key:"withTag",value:function(t){return this.config.tag=t,this}},{key:"withTimeout",value:function(t){return this.config.timeout=t,this}},{key:"withCredentials",value:function(t){return this.config.credentials=t,this}},{key:"withAuthorization",value:function(t){return this.config.authorization=t,this}},{key:"withOnUploadProgress",value:function(t){return this.config.withOnUploadProgress=t,this}},{key:"withOnDownloadProgress",value:function(t){return this.config.withOnDownloadProgress=t,this}},{key:"request",value:function(t){var e=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=this.config.responseType,r=this.buildRequestURL(t),i=this.buildRequestOptions(n),s=this.dispatchRequest(r,i).then((function(t){return e.createResponse(r,t)})).then((function(t){return e.handleResponse(o,t)}));return this.restoreConfig(),s}},{key:"get",value:function(t){return this.request(t,{method:"GET"})}},{key:"post",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;return this.request(t,{method:"POST",body:e})}},{key:"put",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;return this.request(t,{method:"PUT",body:e})}},{key:"patch",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;return this.request(t,{method:"PATCH",body:e})}},{key:"delete",value:function(t){return this.request(t,{method:"DELETE"})}},{key:"cancel",value:function(t){var e=this.xhrTagMap[t];e&&e.forEach((function(t){t&&t.abort&&t.abort()}))}},{key:"restoreConfig",value:function(){this.config={baseURL:this.initConfig.baseURL||void 0,requestType:this.initConfig.requestType||"json",responseType:this.initConfig.responseType||"json",tag:this.initConfig.tag||void 0,timeout:this.initConfig.timeout||0,credentials:this.initConfig.credentials||"same-origin",authorization:this.initConfig.authorization||void 0,withOnUploadProgress:this.initConfig.withOnUploadProgress||void 0,withOnDownloadProgress:this.initConfig.withOnDownloadProgress||void 0}}},{key:"tagXHR",value:function(t,e){var n=this;Object.keys(this.xhrTagMap).forEach((function(t){n.xhrTagMap[t]=n.xhrTagMap[t].filter((function(t){return t.readyState>0&&t.readyState<4}))})),t&&(this.xhrTagMap[t]=[].concat(s(this.xhrTagMap[t]||[]),[e]))}},{key:"buildRequestURL",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return/^([a-z][a-z\d+-.]*:)?\/\//i.test(t)?t:"".concat(this.config.baseURL).concat(t)}},{key:"buildRequestOptions",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e={method:t.method||"GET",timeout:this.config.timeout||0,withCredentials:void 0,responseType:"text",headers:i({},t.headers||{}),body:t.body};return"include"===this.config.credentials?e.withCredentials=!0:"omit"===this.config.credentials&&(e.withCredentials=!1),e.headers.authorization&&(e.headers.Authorization=e.headers.authorization,delete e.headers.authorization),this.config.authorization&&!e.headers.Authorization&&("string"==typeof this.config.authorization&&(e.headers.Authorization=this.config.authorization),"function"==typeof this.config.authorization&&(e.headers.Authorization=this.config.authorization())),"text"===this.config.requestType&&(e.headers["Content-Type"]="text/plain;charset=UTF-8",e.body=this.transformToText(t.body)),"json"===this.config.requestType&&(e.headers["Content-Type"]="application/json;charset=UTF-8",e.body=this.transformToJson(t.body)),"form"===this.config.requestType&&(e.body=this.transformToForm(t.body)),"text"!==this.config.responseType&&"json"!==this.config.responseType||(e.responseType="text"),"blob"===this.config.responseType&&(e.responseType="blob"),e}},{key:"dispatchRequest",value:function(t,e){var n=this,o=e.method,r=e.timeout,i=e.withCredentials,s=e.responseType,a=e.headers,u=e.body;return new Promise((function(e,c){var f=new XMLHttpRequest;if(f.open(o,t),f.timeout=r,f.withCredentials=i,f.responseType=s,a&&Object.keys(a).length>0&&Object.keys(a).forEach((function(t){f.setRequestHeader(t,a[t])})),n.config.withOnUploadProgress&&"function"==typeof n.config.withOnUploadProgress){var h=n.config.withOnUploadProgress;f.upload.onprogress=function(t){h(t)}}if(n.config.withOnDownloadProgress&&"function"==typeof n.config.withOnDownloadProgress){var l=n.config.withOnDownloadProgress;f.onprogress=function(t){l(t)}}f.onloadend=function(){if(f.status)e(f);else{var t=new Error("Request failed");c(t)}},f.ontimeout=function(){var t=new Error("Request timeout");c(t)},f.onabort=function(){var t=new Error("Request aborted");c(t)},f.send(u),n.tagXHR(n.config.tag,f)}))}},{key:"createResponse",value:function(t,e){if(e&&e.status&&e.getAllResponseHeaders){var n=e.status,o=e.statusText,r=e.responseURL,i=e.response,s=e.getAllResponseHeaders().trim().split("\n"),a={};s.forEach((function(t){var e=t.split(": "),n=e.shift(),o=e.join(": ");a[n]=o}));var u=new Response(i,{status:n,statusText:o,headers:a});return Object.defineProperty(u,"url",{value:t}),Object.defineProperty(u,"responseURL",{value:r}),u}}},{key:"handleResponse",value:function(t,e){if(e instanceof Response){var n=e.clone(),o=e.ok,r=e.status,i=e.statusText;if("text"===t&&"function"==typeof e.text)return new Promise((function(t,s){e.text().then((function(e){if(n.data=e,!o){var s=new Error("".concat(r," ").concat(i));throw s.response=n,s}t(n)})).catch((function(t){s(t)}))}));if("json"===t&&"function"==typeof e.text)return new Promise((function(t,s){e.text().then((function(e){try{n.data=JSON.parse(e)}catch(t){n.data=e}if(!o){var s=new Error("".concat(r," ").concat(i));throw s.response=n,s}t(n)})).catch((function(t){s(t)}))}));if("blob"===t&&"function"==typeof e.blob)return new Promise((function(t,s){e.blob().then((function(e){if(n.data=e,!o){var s=new Error("".concat(r," ").concat(i));throw s.response=n,s}t(n)})).catch((function(t){s(t)}))}))}}},{key:"transformToText",value:function(e){return e&&e instanceof FormData?new URLSearchParams(e).toString():e&&"object"===t(e)?JSON.stringify(e):e}},{key:"transformToJson",value:function(e){if(e&&e instanceof FormData){var n={};return e.forEach((function(t,e){void 0!==t&&(n[e]?n[e]=[].concat(s(n[e]),[t]):n[e]=t)})),JSON.stringify(n)}return e&&"object"===t(e)?JSON.stringify(e):e}},{key:"transformToForm",value:function(e){if(e&&e instanceof FormData)return e;if(e&&"object"===t(e)){var n=new FormData;return Object.keys(e).forEach((function(t){var o=e[t];"function"!=typeof o&&null!=o&&(Array.isArray(o)?o.forEach((function(e){n.append(t,e)})):o instanceof File?n.append(t,o):n.append(t,JSON.stringify(o)))})),n}return e}}])&&n(r.prototype,a),u&&n(r,u),o}())}));
